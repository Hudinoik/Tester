<!DOCTYPE html><html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin – Minyanim SA</title>
<link rel="stylesheet" href="style.css"></head><body>
<header><div class="brand"><div class="logo"></div><h1>Minyanim SA – Admin</h1></div><nav><a href="index.html">Public</a></nav></header>
<div class="container">

  <div class="card">
    <h3>Users (Gabaim/Admins)</h3>
    <div class="row"><input id="userSearch" placeholder="Filter by email..." oninput="renderUsers()"></div>
    <div id="users"></div>
    <h4>Create User</h4>
    <div class="row">
      <input id="u_email" placeholder="email" style="max-width:360px">
      <input id="u_pw" type="password" placeholder="password" style="max-width:240px">
      <select id="u_role" style="max-width:180px"><option>gabai</option><option>admin</option><option>superadmin</option></select>
      <button onclick="createUser()">Create</button>
    </div>
    <div class="small muted">Tip: Ctrl/Cmd-click to select multiple shuls.</div>
  </div>

  <div class="card">
    <h3>Data Import / Export</h3>
    <div class="grid grid-2">
      <div>
        <h4>Export</h4>
        <div class="row">
          <button onclick="downloadCSV('/export/users.csv')">Users CSV</button>
          <button onclick="downloadCSV('/export/shuls.csv')">Shuls CSV</button>
          <button onclick="downloadCSV('/export/minyanim.csv')">Minyanim CSV</button>
        </div>
        <div class="small muted">Passwords are exported as secure hashes. To change passwords on import, include a <code>password</code> column.</div>
      </div>
      <div>
        <h4>Import (replace all data)</h4>
        <div class="row">
          <input type="file" id="f_users" accept=".csv">
          <input type="file" id="f_shuls" accept=".csv">
          <input type="file" id="f_minyanim" accept=".csv">
        </div>
        <div class="row"><button onclick="importAll()">Import</button></div>
        <div class="small muted">Provide one or more CSVs. If a CSV is omitted, that table is left as-is.</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>Add a Shul</h3>
    <div class="grid grid-2">
      <div>
        <label>Name</label><input id="add_name">
        <label>Address</label><div class="ac"><input id="add_addr"><div id="add_ac" class="ac-results" style="display:none"></div></div>
        <label>Area</label><input id="add_area">
        <button onclick="addShul()">Add Shul</button>
      </div>
      <div>
        <h4>My Shuls</h4>
        <input id="shulFilter" placeholder="Filter..." oninput="renderShulList()">
        <div id="shulList" class="sidebar"></div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>Edit Selected Shul</h3>
    <div class="grid grid-2">
      <div>
        <label>Name</label><input id="e_name">
        <label>Address</label><div class="ac"><input id="e_addr"><div id="e_ac" class="ac-results" style="display:none"></div></div>
        <label>Area</label><input id="e_area">
        <button onclick="saveShul()">Save Shul</button>
      </div>
      <div>
        <h4>Minyan Times</h4>
        <div id="e_times"></div>
        <div class="row">
          <select id="t_type">
            <option>Shacharis</option><option>Mincha</option><option>Maariv</option><option>Mincha–Maariv (Back-to-back)</option><option>Other</option>
            <option>Shabbos – Candle Lighting</option>
            <option>Shabbos – Mincha (Erev)</option>
            <option>Shabbos – Kabbalat Shabbat</option>
            <option>Shabbos – Shacharis</option>
            <option>Shabbos – Mincha (Day)</option>
            <option>Shabbos – Maariv (Motzei)</option>
            <option>Shabbos – Havdalah</option>
            <option>Shabbos – Other</option>
          </select>
          <input id="t_time" class="time-input" placeholder="HH:MM">
          <input id="t_note" placeholder="Note (optional)">
          <button onclick="addTime()">Add</button>
        </div>
        <div class="row" style="margin-top:8px"><button class="btn-ghost" onclick="saveTimes()">Save All Times</button></div>
      </div>
    </div>
  </div>

</div>
<script src="utils.js"></script>
<script>
let token=null, role=null, users=[], shuls=[], filteredUsers=[], current=null, times=[];

async function init(){
  token=localStorage.getItem('token'); role=localStorage.getItem('role');
  if(!token){ location.href='login.html'; return; }
  await refreshShuls();
  if(role==='superadmin') await loadUsers();
  enableTimePicker();
  attachAutocomplete('add_addr','add_ac'); attachAutocomplete('e_addr','e_ac');
}
/* SHULS */
async function refreshShuls(){ const r=await fetch('/my-shuls',{headers:{Authorization:'Bearer '+token}}); shuls=await r.json(); renderShulList(); }
function renderShulList(){
  const box=document.getElementById('shulList'); const q=(document.getElementById('shulFilter').value||'').toLowerCase();
  const data=shuls.filter(s=>!q || (s.name||'').toLowerCase().includes(q) || (s.address||'').toLowerCase().includes(q));
  box.innerHTML=data.map(s=>`<div class="shul-item" onclick="openShul(${s.id})">${s.name}<div class="small muted">${s.address||''}</div></div>`).join('') || '<p class="muted small">No shuls.</p>';
}
async function openShul(id){ const r=await fetch('/shuls/'+id+'/full'); current=await r.json(); document.getElementById('e_name').value=current.name||''; document.getElementById('e_addr').value=current.address||''; document.getElementById('e_area').value=current.area||''; times=(current.minyanim||[]).map(m=>({type:m.type,time:m.time,note:m.note||''})); renderTimes(); }
function renderTimes(){
  const box=document.getElementById('e_times');
  if(!times.length){ box.innerHTML='<p class="muted small">No times yet.</p>'; return; }
  box.innerHTML=`<table class="table"><thead><tr><th>Type</th><th>Time</th><th>Note</th><th></th></tr></thead><tbody>`+
    times.map((m,i)=>`<tr><td>${m.type}</td><td>${m.time}</td><td>${m.note||''}</td><td><button class="btn-ghost" onclick="rem(${i})">Remove</button></td></tr>`).join('')+`</tbody></table>`;
}
function addTime(){ const t=document.getElementById('t_type').value; const tm=document.getElementById('t_time').value; const n=document.getElementById('t_note').value.trim(); if(!tm) return alert('Pick a time'); times.push({type:t,time:tm,note:n}); document.getElementById('t_time').value=''; document.getElementById('t_note').value=''; renderTimes(); }
function rem(i){ times.splice(i,1); renderTimes(); }
async function saveShul(){ if(!current) return alert('Select a shul'); const body={name:document.getElementById('e_name').value.trim(),address:document.getElementById('e_addr').value.trim(),area:document.getElementById('e_area').value.trim()}; const r=await fetch('/shuls/'+current.id,{method:'PUT',headers:{'Content-Type':'application/json',Authorization:'Bearer '+token},body:JSON.stringify(body)}); alert(r.ok?'Saved shul':'Failed'); if(r.ok) await refreshShuls(); }
async function saveTimes(){ if(!current) return alert('Select a shul'); const r=await fetch('/shuls/'+current.id+'/minyanim',{method:'PUT',headers:{'Content-Type':'application/json',Authorization:'Bearer '+token},body:JSON.stringify(times)}); alert(r.ok?'Saved all times':'Failed'); }

/* USERS */
async function loadUsers(){ const r=await fetch('/users',{headers:{Authorization:'Bearer '+token}}); if(!r.ok){document.getElementById('users').innerHTML='<p class="muted small">Only superadmin can manage users.</p>';return;} users=await r.json(); filteredUsers=[...users]; renderUsers(); }
function renderUsers(){
  const q=(document.getElementById('userSearch').value||'').toLowerCase();
  filteredUsers=users.filter(u=>!q || (u.email||'').toLowerCase().includes(q));
  const tableRows = filteredUsers.map(u=>{
    const assigned=(u.shulIds||'').split(',').filter(Boolean).map(Number);
    const options=shuls.map(s=>`<option value="${s.id}" ${assigned.includes(s.id)?'selected':''}>${s.id} — ${s.name}</option>`).join('');
    const roleSel = `<select id="role-${u.id}"><option value="gabai" ${u.role==='gabai'?'selected':''}>gabai</option><option value="admin" ${u.role==='admin'?'selected':''}>admin</option><option value="superadmin" ${u.role==='superadmin'?'selected':''}>superadmin</option></select>`;
    return `<tr><td>${u.id}</td><td>${u.email}</td><td>${roleSel}</td>
      <td style="width:60%"><select id="assign-${u.id}" class="multi" multiple size="12">${options}</select></td>
      <td class="actions">
        <button class="btn-ghost" onclick="saveAssign(${u.id})">Save Shuls</button>
        <button class="btn-ghost" onclick="saveRole(${u.id})">Save Role</button>
        <button class="btn-ghost" onclick="resetPw(${u.id})">Reset PW</button>
      </td></tr>`;
  }).join('');
  document.getElementById('users').innerHTML=`<table class="table"><thead><tr><th>ID</th><th>Email</th><th>Role</th><th>Assign Shuls</th><th>Actions</th></tr></thead><tbody>${tableRows}</tbody></table>`;
}
async function createUser(){ const body={email:document.getElementById('u_email').value.trim(),password:document.getElementById('u_pw').value.trim(),role:document.getElementById('u_role').value}; const r=await fetch('/users',{method:'POST',headers:{'Content-Type':'application/json',Authorization:'Bearer '+token},body:JSON.stringify(body)}); const j=await r.json(); alert(r.ok?('User #'+j.id+' created'):(j.error||'Failed')); if(r.ok) await loadUsers(); }
async function saveAssign(uid){ const sel=document.getElementById('assign-'+uid); const ids=Array.from(sel.selectedOptions).map(o=>parseInt(o.value,10)); const r=await fetch('/users/'+uid+'/shuls',{method:'PUT',headers:{'Content-Type':'application/json',Authorization:'Bearer '+token},body:JSON.stringify(ids)}); alert(r.ok?'Assignments saved':'Failed'); }
async function saveRole(uid){ const roleNew=document.getElementById('role-'+uid).value; const r=await fetch('/users/'+uid,{method:'PUT',headers:{'Content-Type':'application/json',Authorization:'Bearer '+token},body:JSON.stringify({role:roleNew})}); const j=await r.json().catch(()=>({})); alert(r.ok?'Role updated':(j.error||'Failed')); if(r.ok) await loadUsers(); }
async function resetPw(id){ const pw=prompt('New password:'); if(!pw) return; const r=await fetch('/users/'+id,{method:'PUT',headers:{'Content-Type':'application/json',Authorization:'Bearer '+token},body:JSON.stringify({password:pw})}); alert(r.ok?'Updated':'Failed'); }

/* Import/Export helpers */
function downloadCSV(path){ const a=document.createElement('a'); a.href=path+'?t='+Date.now(); a.setAttribute('download',''); a.target='_blank'; a.click(); }
async function importAll(){
  if(!confirm('This will replace tables you upload. Continue?')) return;
  const fd=new FormData();
  const fu=document.getElementById('f_users').files[0]; const fs=document.getElementById('f_shuls').files[0]; const fm=document.getElementById('f_minyanim').files[0];
  if(fu) fd.append('users',fu); if(fs) fd.append('shuls',fs); if(fm) fd.append('minyanim',fm);
  const r=await fetch('/import?replace=1',{method:'POST',headers:{Authorization:'Bearer '+token},body:fd});
  const j=await r.json().catch(()=>({}));
  alert(r.ok?'Import complete':(j.error||'Import failed'));
  if(r.ok){ await refreshShuls(); if(role==='superadmin') await loadUsers(); }
}

init();
</script>
</body></html>
