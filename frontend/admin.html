
<!DOCTYPE html><html lang='en'><head>
<meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>
<title>Admin – Minyanim SA</title>
<link rel='stylesheet' href='style.css'>
</head><body>
<header><div class='brand'><div class='logo'></div><h1>Minyanim SA – Admin</h1></div><nav><a href='index.html'>Public</a></nav></header>
<div class='container'>

  <!-- USERS (full width) -->
  <div class='card'>
    <h3>Users (Gabaim/Admins)</h3>
    <div class='row'>
      <input id='userSearch' placeholder='Filter users by email...' oninput='renderUsers()'>
    </div>
    <div id='users'></div>
    <h4>Create User</h4>
    <div class='row'>
      <input id='u_email' placeholder='email' style='max-width:360px'>
      <input id='u_pw' type='password' placeholder='password' style='max-width:220px'>
      <select id='u_role' style='max-width:180px'><option>gabai</option><option>admin</option><option>superadmin</option></select>
      <button onclick='createUser()'>Create</button>
    </div>
    <div class='small muted'>Tip: hold Ctrl/Cmd to select multiple shuls in the list.</div>
  </div>

  <!-- TWO-PANE: My Shuls list (left), Editor (right) -->
  <div class='card'>
    <h3>Edit Shuls I Can Access</h3>
    <div class='grid grid-3'>
      <div class='sidebar'>
        <input id='shulFilter' placeholder='Filter shuls...' oninput='renderShulList()'>
        <div id='shulList' class='list' style='margin-top:8px'></div>
      </div>
      <div>
        <h4>Details</h4>
        <label>Name</label><input id='e_name'>
        <label>Address</label><input id='e_addr'>
        <label>Area</label><input id='e_area'>
        <div class='row'><button onclick='saveShul()'>Save Shul</button></div>
      </div>
      <div>
        <h4>Minyan Times</h4>
        <div id='e_times'></div>
        <div class='row'>
          <select id='t_type'><option>Shacharis</option><option>Mincha</option><option>Maariv</option><option>Other</option></select>
          <input id='t_time' placeholder='06:15 or Sun-Thu 18:00'>
          <input id='t_note' placeholder='Note (optional)'>
          <button onclick='addTime()'>Add</button>
        </div>
        <div class='row' style='margin-top:8px'><button class='btn-ghost' onclick='saveTimes()'>Save All Times</button></div>
      </div>
    </div>
  </div>
</div>

<script>
let token=null, role=null, users=[], shuls=[], filteredUsers=[], currentShul=null, times=[];

async function boot(){
  const auth=await promptLogin();
  if(!auth) return;
  await loadShuls();
  if(role==='superadmin'){ await loadUsers(); }
}
async function promptLogin(){
  const email=prompt('Admin email:'); const pw=prompt('Password:');
  if(!email||!pw) return false;
  const r=await fetch('/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password:pw})});
  const j=await r.json(); if(j.token){ token=j.token; role=j.role; return true; } alert(j.error||'Login failed'); return false;
}

/* USERS */
async function loadUsers(){
  const r=await fetch('/users',{headers:{Authorization:'Bearer '+token}});
  if(!r.ok){document.getElementById('users').innerHTML='<p class="muted small">Only superadmin can manage users.</p>';return;}
  users=await r.json(); filteredUsers=[...users]; renderUsers();
}
function renderUsers(){
  const q=(document.getElementById('userSearch').value||'').toLowerCase();
  filteredUsers=users.filter(u=>!q || (u.email||'').toLowerCase().includes(q));
  const tableRows = filteredUsers.map(u=>{
    const assigned=(u.shulIds||'').split(',').filter(Boolean).map(Number);
    const opts = shuls.map(s=>`<option value="${s.id}" ${assigned.includes(s.id)?'selected':''}>${s.id} — ${s.name}</option>`).join('');
    return `<tr>
      <td>${u.id}</td><td>${u.email}</td><td>${u.role}</td>
      <td style="width:60%"><select id="assign-${u.id}" class="multi" multiple size="12">${opts}</select></td>
      <td style="white-space:nowrap">
        <button class="btn-ghost" onclick="saveAssign(${u.id})">Save</button>
        <button class="btn-ghost" onclick="promote(${u.id},'admin')">Make Admin</button>
        <button class="btn-ghost" onclick="resetPw(${u.id})">Reset PW</button>
      </td></tr>`;
  }).join('');
  document.getElementById('users').innerHTML = `<table class='table'><thead><tr><th>ID</th><th>Email</th><th>Role</th><th>Assign Shuls</th><th>Actions</th></tr></thead><tbody>${tableRows}</tbody></table>`;
}
async function createUser(){
  const body={email:document.getElementById('u_email').value.trim(),password:document.getElementById('u_pw').value.trim(),role:document.getElementById('u_role').value};
  const r=await fetch('/users',{method:'POST',headers:{'Content-Type':'application/json',Authorization:'Bearer '+token},body:JSON.stringify(body)});
  const j=await r.json(); if(r.ok){ alert('User #'+j.id+' created'); await loadUsers(); } else alert(j.error||'Failed');
}
async function saveAssign(uid){
  const sel=document.getElementById('assign-'+uid);
  const ids=Array.from(sel.selectedOptions).map(o=>parseInt(o.value,10));
  const r=await fetch('/users/'+uid+'/shuls',{method:'PUT',headers:{'Content-Type':'application/json',Authorization:'Bearer '+token},body:JSON.stringify(ids)});
  alert(r.ok?'Saved':'Failed');
}
async function promote(id,roleNew){
  const r=await fetch('/users/'+id,{method:'PUT',headers:{'Content-Type':'application/json',Authorization:'Bearer '+token},body:JSON.stringify({role:roleNew})});
  alert(r.ok?'Updated':'Failed'); if(r.ok) loadUsers();
}
async function resetPw(id){
  const pw=prompt('New password:'); if(!pw) return;
  const r=await fetch('/users/'+id,{method:'PUT',headers:{'Content-Type':'application/json',Authorization:'Bearer '+token},body:JSON.stringify({password:pw})});
  alert(r.ok?'Updated':'Failed');
}

/* SHUL LIST & EDITOR */
async function loadShuls(){
  const r=await fetch('/my-shuls',{headers:{Authorization:'Bearer '+token}});
  shuls=await r.json(); renderShulList();
}
function renderShulList(){
  const q=(document.getElementById('shulFilter')?.value||'').toLowerCase();
  const data=shuls.filter(s=>!q || (s.name||'').toLowerCase().includes(q) || (s.address||'').toLowerCase().includes(q));
  const html=data.map(s=>`<div class="shul-item ${currentShul&&currentShul.id==s.id?'active':''}" onclick="openShul(${s.id})">${s.name}<div class='small muted'>${s.address||''}</div></div>`).join('');
  document.getElementById('shulList').innerHTML=html || '<p class="muted small">No shuls.</p>';
}
async function openShul(id){
  const r=await fetch('/shuls/'+id+'/full'); currentShul=await r.json();
  document.getElementById('e_name').value=currentShul.name||'';
  document.getElementById('e_addr').value=currentShul.address||'';
  document.getElementById('e_area').value=currentShul.area||'';
  times=(currentShul.minyanim||[]).map(m=>({type:m.type,time:m.time,note:m.note||''}));
  renderTimes();
  renderShulList();
}
function renderTimes(){
  const box=document.getElementById('e_times');
  if(!times.length){ box.innerHTML='<p class="muted small">No times yet.</p>'; return; }
  box.innerHTML = `<table class='table'><thead><tr><th>Type</th><th>Time</th><th>Note</th><th></th></tr></thead><tbody>`+
    times.map((m,i)=>`<tr><td>${m.type}</td><td>${m.time}</td><td>${m.note||''}</td><td><button class='btn-ghost' onclick='removeTime(${i})'>Remove</button></td></tr>`).join('')+
    `</tbody></table>`;
}
function addTime(){ const t=document.getElementById('t_type').value; const tm=document.getElementById('t_time').value.trim(); const n=document.getElementById('t_note').value.trim(); if(!tm) return alert('Enter a time'); times.push({type:t,time:tm,note:n}); document.getElementById('t_time').value=''; document.getElementById('t_note').value=''; renderTimes(); }
function removeTime(i){ times.splice(i,1); renderTimes(); }
async function saveShul(){
  if(!currentShul) return alert('Select a shul first');
  const body={ name:document.getElementById('e_name').value.trim(), address:document.getElementById('e_addr').value.trim(), area:document.getElementById('e_area').value.trim() };
  const r=await fetch('/shuls/'+currentShul.id,{method:'PUT',headers:{'Content-Type':'application/json',Authorization:'Bearer '+token},body:JSON.stringify(body)});
  alert(r.ok?'Saved':'Failed'); if(r.ok) await loadShuls();
}
async function saveTimes(){
  if(!currentShul) return alert('Select a shul first');
  const r=await fetch('/shuls/'+currentShul.id+'/minyanim',{method:'PUT',headers:{'Content-Type':'application/json',Authorization:'Bearer '+token},body:JSON.stringify(times)});
  alert(r.ok?'Saved times':'Failed');
}
boot();
</script>
</body></html>
