<!DOCTYPE html><html lang='en'><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'><title>Admin – Minyanim SA</title><link rel='stylesheet' href='style.css'></head><body><header><div class='brand'><div class='logo'></div><h1>Minyanim SA – Admin</h1></div><nav><a href='index.html'>Public</a></nav></header><div class='container'><div class='card'><h3>Authenticate</h3><div class='grid grid-2'><input id='a_email' placeholder='email'><input id='a_password' type='password' placeholder='password'></div><button onclick='login()'>Login</button><div id='who' class='muted small'></div></div><div class='grid grid-2'><div class='card'><h3>Users (Gabaim/Admins)</h3><div id='users'></div><h4>Create</h4><div class='grid grid-2'><input id='u_email' placeholder='email'><input id='u_pw' type='password' placeholder='password'></div><select id='u_role'><option>gabai</option><option>admin</option><option>superadmin</option></select><button onclick='createUser()'>Create</button></div><div class='card'><h3>Add / Edit Shul</h3><label>Name</label><input id='s_name'><label>Address</label><div class='ac'><input id='s_addr'><div id='s_ac' class='ac-results' style='display:none'></div></div><label>Area</label><input id='s_area'><button onclick='addShul()'>Add Shul</button><div class='muted small'>When saving address we auto-geocode for distance sorting.</div></div></div><div class='card'><h3>All Shuls (IDs)</h3><div id='shuls'></div></div></div><script src='utils.js'></script><script>let token=null,role=null,shuls=[];async function login(){const r=await fetch('/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:document.getElementById('a_email').value,password:document.getElementById('a_password').value})});const j=await r.json();if(j.token){token=j.token;role=j.role;document.getElementById('who').textContent='Logged in as '+role;load();}else alert(j.error||'Login failed');}async function load(){const rs=await fetch('/shuls');shuls=await rs.json();renderShuls();if(role==='superadmin'){const ru=await fetch('/users',{headers:{Authorization:'Bearer '+token}});const users=await ru.json();document.getElementById('users').innerHTML=`<table class='table'><thead><tr><th>ID</th><th>Email</th><th>Role</th><th>Shuls</th><th>Assign</th><th>Actions</th></tr></thead><tbody>`+users.map(u=>{const assigned=(u.shulIds||'').split(',').filter(Boolean).map(Number);const options=shuls.map(s=>`<label class='small'><input type='checkbox' data-uid='${u.id}' value='${s.id}' ${assigned.includes(s.id)?'checked':''}> ${s.id} – ${s.name}</label>`).join('<br>');return `<tr><td>${u.id}</td><td>${u.email}</td><td>${u.role}</td><td>${assigned.join(', ')}</td><td>${options}<div class='row' style='margin-top:6px'><button class='btn-ghost' onclick='saveAssign(${u.id})'>Save</button></div></td><td><button class='btn-ghost' onclick="promote(${u.id},'admin')">Make Admin</button><button class='btn-ghost' onclick='resetPw(${u.id})'>Reset PW</button></td></tr>`;}).join('')+`</tbody></table>`;}else{document.getElementById('users').innerHTML='<p class="muted small">Only superadmin can manage users.</p>'; }attachAutocomplete('s_addr','s_ac');}function collectAssign(uid){return Array.from(document.querySelectorAll(`input[type=checkbox][data-uid="${'${uid}'}"]`)).filter(x=>x.checked).map(x=>parseInt(x.value,10));}async function saveAssign(uid){const ids=Array.from(document.querySelectorAll(`input[type=checkbox][data-uid='${'${uid}'}']`)).filter(x=>x.checked).map(x=>parseInt(x.value,10));const r=await fetch(`/users/${uid}/shuls`,{method:'PUT',headers:{'Content-Type':'application/json',Authorization:'Bearer '+token},body:JSON.stringify(ids)});if(r.ok){alert('Assignments saved');load();}else alert('Failed');}async function promote(id,roleNew){const r=await fetch(`/users/${id}`,{method:'PUT',headers:{'Content-Type':'application/json',Authorization:'Bearer '+token},body:JSON.stringify({role:roleNew})});if(r.ok){load();}else alert('Failed');}async function resetPw(id){const pw=prompt('New password:');if(!pw)return;const r=await fetch(`/users/${id}`,{method:'PUT',headers:{'Content-Type':'application/json',Authorization:'Bearer '+token},body:JSON.stringify({password:pw})});alert(r.ok?'Updated':'Failed');}async function addShul(){const body={name:document.getElementById('s_name').value.trim(),address:document.getElementById('s_addr').value.trim(),area:document.getElementById('s_area').value.trim()};const r=await fetch('/shuls',{method:'POST',headers:{'Content-Type':'application/json',Authorization:'Bearer '+token},body:JSON.stringify(body)});const j=await r.json();if(r.ok){alert('Shul created ID '+j.id);load();}else alert(j.error||'Failed');}function renderShuls(){const rows=shuls.map(s=>`<tr><td>${s.id}</td><td>${s.name}</td><td>${s.address||''}</td></tr>`).join('');document.getElementById('shuls').innerHTML=`<table class='table'><thead><tr><th>ID</th><th>Name</th><th>Address</th></tr></thead><tbody>${rows}</tbody></table>`;}</script></body></html>