<!DOCTYPE html><html lang='en'><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'><title>Gabai – Minyanim SA</title><link rel='stylesheet' href='style.css'></head><body><header><div class='brand'><div class='logo'></div><h1>Minyanim SA – Gabai</h1></div><nav><a href='index.html'>Public</a><a href='admin.html'>Admin</a></nav></header><div class='container' style='max-width:760px'><div class='card'><h3>Pick Shul</h3><select id='shulSel' onchange='loadCurrent()'></select></div><div class='card'><h3>Shul Details</h3><label>Name</label><input id='name'><label>Address</label><div class='ac'><input id='address'><div id='ac' class='ac-results' style='display:none'></div></div><label>Area (optional)</label><input id='area'><div class='row' style='margin-top:8px'><button onclick='saveShul()'>Save Shul</button></div></div><div class='card'><h3>Minyan Times</h3><div id='minyan-list'></div><div class='grid grid-2'><select id='m_type'><option>Shacharis</option><option>Mincha</option><option>Maariv</option><option>Other</option></select><input id='m_time' placeholder='e.g. 06:15 or Sun-Thu 18:00'></div><input id='m_note' placeholder='Note (optional)'><div class='row' style='margin-top:8px'><button onclick='addMinyan()'>Add Minyan</button></div></div><div class='card'><button onclick='saveMinyanim()'>Save All Times</button></div></div><script>function attachAutocomplete(i,r){const input=document.getElementById(i);const res=document.getElementById(r);let t=null;input.addEventListener('input',()=>{clearTimeout(t);const q=input.value.trim();if(!q){res.innerHTML='';res.style.display='none';return;}t=setTimeout(async()=>{try{const f=await fetch('https://nominatim.openstreetmap.org/search?format=json&q='+encodeURIComponent(q)+'&limit=6');const d=await f.json();res.innerHTML=d.map(v=>`<div class='ac-item' data-v='${v.display_name}'>${v.display_name}</div>`).join('');res.style.display=d.length?'block':'none';}catch(e){res.innerHTML='';res.style.display='none';}},300);});res.addEventListener('click',e=>{const el=e.target.closest('.ac-item');if(!el)return;input.value=el.getAttribute('data-v');res.innerHTML='';res.style.display='none';});}let token,shuls=[],current=null,minyanItems=[];async function init(){token=localStorage.getItem('token');if(!token){location.href='login.html';return;}attachAutocomplete('address','ac');const r=await fetch('/my-shuls',{headers:{Authorization:'Bearer '+token}});shuls=await r.json();if(!shuls.length){alert('No shuls assigned. Ask admin.');return;}document.getElementById('shulSel').innerHTML=shuls.map(s=>`<option value='${s.id}'>${s.name}</option>`).join('');loadCurrent();}function loadCurrent(){const id=parseInt(document.getElementById('shulSel').value,10);current=shuls.find(s=>s.id===id);document.getElementById('name').value=current.name||'';document.getElementById('address').value=current.address||'';document.getElementById('area').value=current.area||'';minyanItems=(current.minyanim||[]).map(m=>({type:m.type,time:m.time,note:m.note||''}));renderMinyan();}function renderMinyan(){const box=document.getElementById('minyan-list');if(!minyanItems.length){box.innerHTML='<p class="muted small">No minyanim yet.</p>';return;}box.innerHTML=`<table class='table'><thead><tr><th>Type</th><th>Time</th><th>Note</th><th></th></tr></thead><tbody>`+minyanItems.map((m,i)=>`<tr><td>${m.type}</td><td>${m.time}</td><td>${m.note||''}</td><td><button class='btn-ghost' onclick='rem(${i})'>Remove</button></td></tr>`).join('')+`</tbody></table>`;}function addMinyan(){const t=document.getElementById('m_type').value;const tm=document.getElementById('m_time').value.trim();const n=document.getElementById('m_note').value.trim();if(!tm)return alert('Enter a time');minyanItems.push({type:t,time:tm,note:n});document.getElementById('m_time').value='';document.getElementById('m_note').value='';renderMinyan();}function rem(i){minyanItems.splice(i,1);renderMinyan();}async function saveShul(){const body={name:document.getElementById('name').value.trim(),address:document.getElementById('address').value.trim(),area:document.getElementById('area').value.trim()};const r=await fetch(`/shuls/${current.id}`,{method:'PUT',headers:{'Content-Type':'application/json',Authorization:'Bearer '+token},body:JSON.stringify(body)});if(r.ok){alert('Saved shul.');}else{const j=await r.json().catch(()=>({}));alert(j.error||'Failed');}}async function saveMinyanim(){const r=await fetch(`/shuls/${current.id}/minyanim`,{method:'PUT',headers:{'Content-Type':'application/json',Authorization:'Bearer '+token},body:JSON.stringify(minyanItems)});if(r.ok){alert('Saved times.');}else{const j=await r.json().catch(()=>({}));alert(j.error||'Failed');}}init();</script></body></html>