<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Minyanim SA</title><link rel="stylesheet" href="style.css"></head><body>
<header><div class="brand"><div class="logo"></div><h1>Minyanim SA</h1></div><nav><a href="login.html">Gabai/Admin Login</a></nav></header>
<div class="container">
  <div class="card"><div class="grid grid-2">
    <input id="q" placeholder="Search by shul name or address" oninput="render()">
    <div class="row"><select id="type" onchange="render()"><option value="">All Types</option><option>Shacharis</option><option>Mincha</option><option>Maariv</option><option>Other</option></select><input id="timeq" placeholder="Find time e.g. 06:15 or 18:" oninput="render()"></div>
    <div class="row"><button id="geoBtn" class="btn-ghost" onclick="getLocation()">Use my location</button><select id="sort" onchange="render()"><option value="name">Sort A–Z</option><option value="distance">Sort by distance</option><option value="favs">Favourites first</option></select></div>
  </div></div>
  <div class="list" id="list" style="margin-top:12px"></div>
</div>
<div class="footer small">© <span id="yr"></span> Minyanim SA</div>
<script src="utils.js"></script>
<script>
let all=[],myPos=null;
async function load(){const r=await fetch("/shuls");all=await r.json();render();}
function timesLine(s){const bt={Shacharis:[],Mincha:[],Maariv:[],Other:[]};(s.minyanim||[]).forEach(m=>{(bt[m.type]||bt.Other).push(m.time)});const piece=t=>bt[t].length?`<div><span class="badge">${t}</span>${bt[t].join(", ")}</div>`:"";return piece("Shacharis")+piece("Mincha")+piece("Maariv")+piece("Other");}
function render(){const q=(document.getElementById("q").value||"").toLowerCase().trim();const tq=(document.getElementById("timeq").value||"").toLowerCase().trim();const typ=(document.getElementById("type").value||"");const mode=document.getElementById("sort").value;
  let data=all.filter(s=>{const txt=((s.name||"")+" "+(s.address||"")).toLowerCase();const timeTxt=(s.minyanim||[]).map(m=>`${m.type} ${m.time} ${m.note||""}`.toLowerCase()).join("|");const matchQ=!q||txt.includes(q);const matchT=!tq||timeTxt.includes(tq);const matchType=!typ||(s.minyanim||[]).some(m=>m.type===typ);return matchQ&&matchT&&matchType;});
  if(mode==="distance"&&myPos){data=data.map(s=>({...s,_d:haversine(myPos.lat,myPos.lon,s.lat,s.lon)})).sort((a,b)=>a._d-b._d);}else if(mode==="favs"){data.sort((a,b)=>(isFav(b.id)-isFav(a.id))||a.name.localeCompare(b.name));}else{data.sort((a,b)=>a.name.localeCompare(b.name));}
  document.getElementById("list").innerHTML=data.map(s=>{const d=myPos&&s.lat!=null?`${(haversine(myPos.lat,myPos.lon,s.lat,s.lon)).toFixed(1)} km`:"";const star=isFav(s.id)?"★":"☆";return `<div class="card"><h3>${s.name}</h3><div class="kv"><span class="muted small">${s.address||""}</span>${d?`<span class="badge">${d}</span>`:""}</div><div style="margin-top:6px">${timesLine(s)||'<span class="muted small">No times yet</span>'}</div><div class="row" style="margin-top:8px"><button class="btn-ghost" onclick="copyText('${(s.address or '').replace(\"'\",\"\\'\")}')">Copy address</button><a class="btn-ghost" href="${mapLink(s)}" target="_blank">Open in Maps</a><button class="btn-ghost" onclick="toggleFav(${s.id});render()">${star} Favourite</button></div></div>`;}).join("");}
function getLocation(){navigator.geolocation?.getCurrentPosition(p=>{myPos={lat:p.coords.latitude,lon:p.coords.longitude};document.getElementById("geoBtn").textContent="Location set";render();},e=>alert("Could not get location"));}document.getElementById("yr").textContent=new Date().getFullYear();load();
</script></body></html>