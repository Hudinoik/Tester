<!DOCTYPE html><html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Minyanim SA</title>
<link rel="stylesheet" href="style.css"></head><body>
<header><div class="brand"><div class="logo"></div><h1>Minyanim SA</h1></div><nav><a href="login.html">Gabai/Admin Login</a></nav></header>
<div class="container">
  <div class="card">
    <div class="grid grid-2">
      <input id="q" placeholder="Search by shul name or address" oninput="render()">
      <div class="row">
        <select id="type" onchange="render()">
          <option value="">All Types</option>
          <option>Shacharis</option><option>Mincha</option><option>Maariv</option>
          <option>Mincha–Maariv (Back-to-back)</option>
          <option>Shabbos</option><option>Other</option>
        </select>
        <input id="timeq" class="time-input" placeholder="Time" oninput="render()">
      </div>
      <div class="row">
        <button id="geoBtn" class="btn-ghost" onclick="getLocation()">Use my location</button>
        <select id="sort" onchange="render()"><option value="name">Sort A–Z</option><option value="distance">Sort by distance</option><option value="soonest">Sort by soonest</option><option value="favs">Favourites first</option></select>
        <span id="locNote" class="muted small"></span>
      </div>
    </div>
  </div>
  <div class="list" id="list"></div>
</div>
<div class="footer small">© <span id="yr"></span> Minyanim SA</div>
<script src="utils.js"></script>
<script>
let all=[], myPos=null;
async function load(){ const r=await fetch('/shuls?ts='+Date.now()); all=await r.json(); enableTimePicker(); render(); }
function fmt(t,n){ return n?`${t} (${n})`:t; }
function timesLine(s){
  const g={Shacharis:[],Mincha:[],Maariv:[],Shabbos:[],Other:[],BackToBack:[]};
  (s.minyanim||[]).forEach(m=>{
    if((m.type||'').startsWith('Shabbos')){
      const lab=m.type.replace('Shabbos – ','').replace('Shabbos-','').replace('Shabbos ',''); g.Shabbos.push(fmt(`${lab}: ${m.time}`, m.note));
    }else if(m.type==='Mincha–Maariv (Back-to-back)'){
      g.BackToBack.push(fmt(m.time,m.note));
    }else if(g[m.type]){ g[m.type].push(fmt(m.time,m.note)); } else { g.Other.push(fmt(`${m.type}: ${m.time}`,m.note)); }
  });
  const piece=(label,arr)=>arr.length?`<div><span class="badge">${label}</span>${arr.join(", ")}</div>`:"";
  return piece("Shacharis",g.Shacharis)+piece("Mincha",g.Mincha)+piece("Maariv",g.Maariv)+piece("Mincha–Maariv",g.BackToBack)+piece("Shabbos",g.Shabbos)+piece("Other",g.Other);
}
function matchTypeEntry(m, typ){
  if(!typ) return true;
  if(typ==="Shabbos") return (m.type||'').startsWith('Shabbos');
  return m.type===typ;
}
function soonestMinutesForShul(s, typFilter){
  const mins=(s.minyanim||[])
    .filter(m=>matchTypeEntry(m, typFilter))
    .map(m=>parseHHMM(m.time))
    .filter(Boolean)
    .map(t=>minutesUntilNext(t.h,t.mi));
  return mins.length? Math.min(...mins): Infinity;
}
function render(){
  const q=(document.getElementById('q').value||'').toLowerCase().trim();
  const tq=(document.getElementById('timeq').value||'').trim();
  const typ=(document.getElementById('type').value||'');
  const mode=document.getElementById('sort').value;
  let data=all.filter(s=>{
    const txt=((s.name||'')+' '+(s.address||'')).toLowerCase();
    const matchQ=!q || txt.includes(q);
    const matchType=!typ || (s.minyanim||[]).some(m=>matchTypeEntry(m,typ));
    const matchTime=!tq || (s.minyanim||[]).some(m=> (m.time||'').startsWith(tq) || ((m.time||'').indexOf(tq)>=0) );
    return matchQ && matchType && matchTime;
  });
  if(mode==='distance'&&myPos){ data=data.map(s=>({...s,_d:haversine(myPos.lat,myPos.lon,s.lat,s.lon)})).sort((a,b)=>a._d-b._d); }
  else if(mode==='soonest'){ data=data.map(s=>({...s,_n:soonestMinutesForShul(s, typ||null)})).sort((a,b)=>a._n-b._n); }
  else if(mode==='favs'){ data.sort((a,b)=>(isFav(b.id)-isFav(a.id))||a.name.localeCompare(b.name)); }
  else{ data.sort((a,b)=>a.name.localeCompare(b.name)); }
  document.getElementById('list').innerHTML=data.map(s=>{
    const d=myPos && s.lat!=null? `${(haversine(myPos.lat,myPos.lon,s.lat,s.lon)).toFixed(1)} km` : '';
    const star=isFav(s.id)?'★':'☆';
    const addr=(s.address||'').replace(/'/g,"\\'");
    return `<div class="card">
      <h3>${s.name}</h3>
      <div class="kv"><span class="muted small">${s.address||''}</span>${d?`<span class="badge">${d}</span>`:''}</div>
      <div style="margin-top:6px">${timesLine(s)||'<span class="muted small">No times listed yet</span>'}</div>
      <div class="row" style="margin-top:8px">
        <button class="btn-ghost" onclick="copyText('${addr}')">Copy address</button>
        <a class="btn-ghost" href="${mapLink(s)}" target="_blank" rel="noopener">Open in Maps</a>
        <button class="btn-ghost" onclick="toggleFav(${s.id}); render()">${star} Favourite</button>
      </div>
    </div>`;
  }).join('');
}
function getLocation(){
  if(location.protocol!=='https:'){ alert('Location requires HTTPS. Open the secure site URL.'); return; }
  if(!navigator.geolocation){ alert('Geolocation not supported on this device.'); return; }
  navigator.geolocation.getCurrentPosition(
    p=>{ myPos={lat:p.coords.latitude, lon:p.coords.longitude}; document.getElementById('geoBtn').textContent='Location set'; document.getElementById('locNote').textContent='Distance sorting uses saved coordinates.'; render(); },
    e=>{ alert('Please allow location permission in your browser settings.'); },
    {enableHighAccuracy:true, timeout:10000, maximumAge:0}
  );
}
document.getElementById('yr').textContent=(new Date()).getFullYear();
enableTimePicker(); load();
</script>
</body></html>
